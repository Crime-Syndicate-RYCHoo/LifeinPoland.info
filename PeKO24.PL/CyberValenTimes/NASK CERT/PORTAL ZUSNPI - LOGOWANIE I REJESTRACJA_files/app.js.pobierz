require.config(config.require);require(["adapter/dom","pubsub","adapter/enumerable","events/event","common/utils"],function(h,d,b,f,a){var e=namespace("sun.page.modules");var c=this;var g={name:"core",pagePlugins:{},pagePluginsEvents:{},actionThreads:{},actionIdIterator:0,start:function(i,m,r,j){var s=this;var l=j.eventNs||i,q=this.buildPluginId(i,m,r),n=l+"."+m+((r)?"-"+r:"");if(s.pagePlugins[q]){return}s.pagePlugins[q]={};window.totalTime=0;partTime=0;var o=new RegExp("^(http[s]?:/)?(/[0-9A-Za-z-\\.@:%_+~#=]+)+([.]js)$","i");var k=(o.test(m))?m:config.pluginsPath+m;p=require([k],function(u){testTimeStart=new Date().getTime();s.pagePluginsEvents[q]={};s.pagePluginsEvents[q][f.events.pluginInit]=d.subscribe(n+"."+f.events.pluginInit,s.onPluginInit.bind(s));s.pagePluginsEvents[q][f.events.pluginInitError]=d.subscribe(n+"."+f.events.pluginInitError,s.onPluginInitError.bind(s));s.pagePluginsEvents[q][f.events.pluginStop]=d.subscribe(n+"."+f.events.pluginStop,s.onPluginStop.bind(s));s.pagePluginsEvents[q][f.events.pluginAsk]=d.subscribe(n+"."+f.events.pluginAsk,s.pluginAskHandler.bind(s));s.pagePluginsEvents[q][f.events.pluginEvent]=d.subscribe(n,s.pluginEventHandler.bind(s));s.pagePlugins[q]=new u(i,m,r,j);window.testTimeEnd=new Date().getTime();partTime=testTimeEnd-testTimeStart;window.totalTime=window.totalTime+partTime;var t=partTime>config.performanceWarnThreshold?"warn":"info";s[t]("Initialization for ",m," took: ",partTime," miliseconds");window.pluginNum++;s[t]("window.pluginNum ",window.pluginNum," window.pluginsLength: ",window.pluginsLength);if(window.pluginNum===window.pluginsLength){setTimeout(function(){s.info("Total execution time: ",window.totalTime," miliseconds");if(window.ac){var w=new Date().getTime();var v=ac.initArticleJsCollection;s.info("loadArticleJS ",v);if(v){v()}s.info("Articles execution time: ",new Date().getTime()-w," miliseconds")}}.bind(this),0)}})},startAll:function(j){j=j||document;var i=this.getPluginsFromContext(j);i=b.defaults(i,config.commonPlugins);window.pluginsLength=b.toArray(i).length;window.pluginNum=0;this.info("window.pluginsLength: ",window.pluginsLength,i);b.each(i,function(l,k){this.startOne(l)},this)},startOne:function(i){var q=i.modId,o=i.name,u=i.subname,t=i.eventNameSpace,l=i.params||{},j=i.view||q;if(t){b.extend(l,{eventNs:t})}if(l.dynamic===true&&l.event){window.pluginNum++;this.info("initialization will be dynamic for: ",j);j=h.find("#"+j);h.on(j,l.event,this.eventInit.bind(this,q,o,u,l,j))}else{if(l.minResolution||l.maxResolution||l.onlyDevice||!b.isUndefined(l.initMediaQuery)){window.pluginNum++;var k=l.minResolution||0,m=l.maxResolution||10000,s=l.onlyDevice||"all",r=l.initMediaQuery;if(s==="all"||(s==="touch"&&a.device.isTouch)||(s==="non-touch"&&!a.device.isTouch)){var n=b.debounce(function(){this.resDependInit(q,o,u,l,k,m,r)},200);h.on(window,"resize",null,null,n.bind(this));this.resDependInit(q,o,u,l,k,m,r)}}else{this.start(q,o,u,l)}}},resDependInit:function(o,n,r,l,k,m,q){var i,j;if(b.isUndefined(q)){i=h.width(window);j=(i<=m&&i>=k)}else{j=a.device.isState(q)}if(j){this.start(o,n,r,l)}else{this.stop(this.buildPluginId(o,n,r))}},eventInit:function(m,j,l,k,i){this.info("Dynamic initialization: ",j,i);this.start(m,j,l,k);h.off(i,k.event,k.selector,k.data)},stop:function(i){if(!this.pagePlugins[i]){return}this.log("stop "+i);this.pagePlugins[i].stop();delete this.pagePlugins[i]},stopAll:function(j){var i;if(!j){i=this.pagePlugins}else{i=this.getModulePluginsByModId(j)}b.each(i,function(l,k){this.stop(l.pluginId)},this)},getPluginsFromContext:function(l){var k={},i=this;if(window.plugins){k=b.clone(window.plugins)}var j=h.find("."+config.jsModuleClass,l);b.each(j,function(o){var n=h.getData(o,config.jsDataAttr);if(n){var m=n.split(",");b.each(m,function(x,v){var w=x.indexOf("*"),u=h.identify(o,config.namespace),r=u,t=(w!=-1)?x.substr(w+1):undefined,x=(w!=-1)?x.substr(0,w):x,q=i.buildPluginId(r,x,t),s=window[q]||{};k[q]={modId:r,name:x,subname:t,params:s||{},view:o}},this)}},this);return k},onPluginInit:function(j,k){var i=this;this.log("onPluginInit: ",k);this.log("Initialized plugin: ",k.eventSource);var l=k.eventSourceId;h.addClass("#"+l,config.jsModuleClass);d.unsubscribe(i.pagePluginsEvents[k.eventSource][f.events.pluginInit]);d.unsubscribe(i.pagePluginsEvents[k.eventSource][f.events.pluginInitError])},onPluginInitError:function(j,k){var i=this;this.warn("onPluginInitError: ",k.msg);this.warn("!!!! NOT Initialized plugin: ",k.eventSource);d.unsubscribe(i.pagePluginsEvents[k.eventSource][f.events.pluginInit]);d.unsubscribe(i.pagePluginsEvents[k.eventSource][f.events.pluginInitError]);this.stop(k.eventSource)},onPluginStop:function(j,k){var i=this;this.log("onPluginStop: ",k);this.log("Stopped plugin: ",k.eventSource);b.each(this.pagePluginsEvents[k.eventSource],function(l){d.unsubscribe(l)});delete this.pagePluginsEvents[k.eventSource];delete this.pagePlugins[k.eventSource]},onDomReady:function(){this.startAll()},getModulePluginsByModId:function(i){return b.filter(this.pagePlugins,function(j){return j.modId==i})},getModulePluginsByNamespace:function(i){return b.filter(this.pagePlugins,function(j){return j.eventNamespace==i})},pluginAskHandler:function(j,m){var t=this;var q=j.split(".")[0];var k=j.split(".")[1];var o=j.slice(q.length+k.length+2);var r=q+"."+k+".";this.log("Core get ask from plugin "+q+"::"+k,m);var n=this.getModulePluginsByNamespace(q);var s=new Array();b.each(n,function(w,u){var v=w.isInterested(m.action);if(q!=w.modId||w.name!=k){this.log(w.modId+"::"+w.name+" answer for action '"+m.action+"' is: ",v);if(v){s.push(w)}}},this);this.log("Core gets "+s.length+" positive answers from plugins ");if(!s.length){this.log("dispatch answer: OK (status:1) (no one interested)");var l={status:1,actionToken:m.actionToken,eventSource:this.name,data:m.data};this.handleAction(m);d.publish(r+f.events.pluginAnswer,l)}else{var i=this.getNextActionId();this.actionThreads[i]={actionToken:m.actionToken,asked:s.length,answered:0,sourcePrefix:r,status:1};b.each(s,function(y,u){var w=y.getEventPrefix();var v=d.subscribe(w+f.events.pluginActionAnswer,t.onPluginActionAnswer.bind(t));var x={action:m.action,actionId:i,token:v,eventSource:this.name,data:m.data};this.log("dispatch action "+w+f.events.pluginActionCall,x);d.publish(w+f.events.pluginActionCall,x)},this)}},pluginEventHandler:function(m,o){var l=this;if(o&&o.eventSource==l.name){return}var j=m.split(".");var i=j[0];var q=j[1];var k=m.slice(j[0].length+j[1].length+2);if(k!=f.events.pluginInit&&k!=f.events.pluginInitError&&k!=f.events.pluginStop&&k!=f.events.pluginAsk&&k!=f.events.pluginInnerAjaxed){var n=this.getModulePluginsByNamespace(i);b.each(n,function(s,r){if(s.name!=q){var t=s.getEventPrefix();if(!o){o={}}o.eventSource=l.name;this.log("dispatch event to namespace "+t+k,o);d.publish(t+k,o)}},this)}},onPluginActionAnswer:function(j,k){d.unsubscribe(k.token);this.log("onPluginActionAnswer",j,k);this.actionThreads[k.actionId].answered++;this.actionThreads[k.actionId].status*=k.status;if(this.actionThreads[k.actionId].answered==this.actionThreads[k.actionId].asked){this.log("dispatch answer: "+this.actionThreads[k.actionId].status+" (all answers)");var i={status:this.actionThreads[k.actionId].status,actionToken:this.actionThreads[k.actionId].actionToken,eventSource:this.name,data:k.data};if(i.status){this.handleAction(k)}d.publish(this.actionThreads[k.actionId].sourcePrefix+f.events.pluginAnswer,i)}},handleAction:function(j){if(j.action=="ajax.update"){var i=j.data.toUpdate.split(",");b.each(i,function(l){var k=h.find("."+config.jsModuleClass,"#"+l);b.each(k,function(m){this.stopAll(m.id)},this);if(h.hasClass("#"+l,config.jsModuleClass)){this.stopAll(l)}},this)}},getNextActionId:function(){while(this.actionThreads[this.actionIdIterator]!=null){this.actionIdIterator++}return this.actionIdIterator},talkToPlugin:function(i,m,k,l){if(!l){l={}}l.eventSource=this.name;var j=i+"."+m+".";d.publish(j+k,l);this.log("talks to plugin: ",j,", event: "+k)},buildPluginId:function(k,i,j){return k+"--"+i.replace(".","_")+(j?"--"+j:"")},log:function(){var i=Array.prototype.slice.call(arguments),j;i.unshift("@App: ");a.dev.log.bind(this)(i)},info:function(){var i=Array.prototype.slice.call(arguments),j;i.unshift("@App: ");a.dev.info.bind(this)(i)},warn:function(){var i=Array.prototype.slice.call(arguments),j;i.unshift("@App: ");a.dev.warn.bind(this)(i)}};f.Core=g;g.startAll();d.subscribe(f.events.domUpdate,function(k,j){g.startAll(j.appendTo);var l=h.parents("#"+j.update.id,"."+config.jsModuleClass);var i=new Array();b.each(l,function(n){var m=g.getModulePluginsByModId(n.id);b.each(m,function(o){i.push(o)},g)},g);b.each(i,function(m){var n=m.getEventPrefix();this.log("dispatch action "+n+f.events.pluginInnerAjaxed,j.update.id);d.publish(n+f.events.pluginInnerAjaxed,j.update.id)},g)})});